---
# VirtualService for api-gateway with retry policy
apiVersion: networking.istio.io/v1
kind: VirtualService
metadata:
  name: api-gateway
  namespace: petclinic
spec:
  hosts:
    - api-gateway
  http:
    - route:
        - destination:
            host: api-gateway
            port:
              number: 8080
      timeout: 30s
      retries:
        attempts: 3
        perTryTimeout: 10s
        retryOn: 5xx,reset,connect-failure,retriable-4xx
---
# VirtualService for customers-service with retry policy
apiVersion: networking.istio.io/v1
kind: VirtualService
metadata:
  name: customers-service
  namespace: petclinic
spec:
  hosts:
    - customers-service
  http:
    - route:
        - destination:
            host: customers-service
            port:
              number: 8080
      timeout: 15s
      retries:
        attempts: 3
        perTryTimeout: 5s
        retryOn: 5xx,reset,connect-failure
---
# VirtualService for vets-service with retry policy
apiVersion: networking.istio.io/v1
kind: VirtualService
metadata:
  name: vets-service
  namespace: petclinic
spec:
  hosts:
    - vets-service
  http:
    - route:
        - destination:
            host: vets-service
            port:
              number: 8080
      timeout: 15s
      retries:
        attempts: 3
        perTryTimeout: 5s
        retryOn: 5xx,reset,connect-failure
---
# VirtualService for visits-service with retry policy
apiVersion: networking.istio.io/v1
kind: VirtualService
metadata:
  name: visits-service
  namespace: petclinic
spec:
  hosts:
    - visits-service
  http:
    - route:
        - destination:
            host: visits-service
            port:
              number: 8080
      timeout: 15s
      retries:
        attempts: 3
        perTryTimeout: 5s
        retryOn: 5xx,reset,connect-failure
---
# VirtualService for config-server
apiVersion: networking.istio.io/v1
kind: VirtualService
metadata:
  name: config-server
  namespace: petclinic
spec:
  hosts:
    - config-server
  http:
    - route:
        - destination:
            host: config-server
            port:
              number: 8888
      timeout: 30s
      retries:
        attempts: 5
        perTryTimeout: 6s
        retryOn: 5xx,reset,connect-failure
---
# VirtualService for discovery-server (Eureka)
apiVersion: networking.istio.io/v1
kind: VirtualService
metadata:
  name: discovery-server
  namespace: petclinic
spec:
  hosts:
    - discovery-server
  http:
    - route:
        - destination:
            host: discovery-server
            port:
              number: 8761
      timeout: 30s
      retries:
        attempts: 5
        perTryTimeout: 6s
        retryOn: 5xx,reset,connect-failure

