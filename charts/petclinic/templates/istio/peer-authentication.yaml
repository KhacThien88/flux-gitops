{{- if .Values.global.istio.enabled }}
---
# Enable STRICT mTLS for petclinic namespace
apiVersion: security.istio.io/v1
kind: PeerAuthentication
metadata:
  name: petclinic-mtls
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "petclinic.labels" . | nindent 4 }}
spec:
  mtls:
    mode: STRICT
---
# DestinationRule to enforce mTLS for all services in petclinic
apiVersion: networking.istio.io/v1
kind: DestinationRule
metadata:
  name: petclinic-mtls
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "petclinic.labels" . | nindent 4 }}
spec:
  host: "*.{{ .Values.global.namespace }}.svc.cluster.local"
  trafficPolicy:
    tls:
      mode: ISTIO_MUTUAL
---
# DestinationRule for discovery-server to force HTTP/1.1
# This fixes Eureka client issues with HTTP/2 upgrades
apiVersion: networking.istio.io/v1
kind: DestinationRule
metadata:
  name: discovery-server-http1
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "petclinic.labels" . | nindent 4 }}
spec:
  host: {{ .Values.discoveryServer.name }}.{{ .Values.global.namespace }}.svc.cluster.local
  trafficPolicy:
    tls:
      mode: ISTIO_MUTUAL
    connectionPool:
      http:
        h2UpgradePolicy: DO_NOT_UPGRADE
{{- end }}

