{{- if .Values.global.istio.enabled }}
---
# Enable PERMISSIVE mTLS for petclinic namespace
# PERMISSIVE allows both mTLS and plaintext to support services without sidecar
apiVersion: security.istio.io/v1
kind: PeerAuthentication
metadata:
  name: petclinic-mtls
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "petclinic.labels" . | nindent 4 }}
spec:
  mtls:
    mode: PERMISSIVE
---
# DestinationRule for services WITH sidecar - use mTLS
apiVersion: networking.istio.io/v1
kind: DestinationRule
metadata:
  name: petclinic-mtls
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "petclinic.labels" . | nindent 4 }}
spec:
  host: "*.{{ .Values.global.namespace }}.svc.cluster.local"
  trafficPolicy:
    tls:
      mode: ISTIO_MUTUAL
---
# DestinationRule for discovery-server - DISABLE TLS (no sidecar)
apiVersion: networking.istio.io/v1
kind: DestinationRule
metadata:
  name: discovery-server-no-tls
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "petclinic.labels" . | nindent 4 }}
spec:
  host: {{ .Values.discoveryServer.name }}.{{ .Values.global.namespace }}.svc.cluster.local
  trafficPolicy:
    tls:
      mode: DISABLE
---
# DestinationRule for config-server - DISABLE TLS (no sidecar)
apiVersion: networking.istio.io/v1
kind: DestinationRule
metadata:
  name: config-server-no-tls
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "petclinic.labels" . | nindent 4 }}
spec:
  host: {{ .Values.configServer.name }}.{{ .Values.global.namespace }}.svc.cluster.local
  trafficPolicy:
    tls:
      mode: DISABLE
{{- end }}

